openapi: 3.0.3
info:
  title: PayEvo Gateway API
  description: |
    API REST para integração com o gateway de pagamentos PayEvo.

    ---
    
    A API foi projetada com base na arquitetura REST, garantindo que todas as respostas sejam retornadas no formato JSON.
    
    Para acessar os recursos da API, é necessário autenticar-se utilizando o método **Basic Authentication**, fornecendo sua chave secreta como credencial.
    
    Suas chaves de autenticação podem ser localizadas no painel de controle, navegando até **Configurações → Credenciais de API**.

    Depois de obter sua chave, inclua-a no cabeçalho da requisição no campo Authorization, conforme a estrutura demonstrada abaixo:
    
    ## Postbacks
    
    Ao registrar uma transação, é possível definir uma URL específica para receber notificações sempre que houver atualizações no status da transação. Para isso, utilize o campo `postbackUrl` na criação da transação. Os dados enviados para essa URL seguirão o formato do schema `Postback`.
  version: 2.1.0

servers:
  - url: http://apiv2.payevo.com.br/functions/v1
    description: Servidor de produção

security:
  - basicAuth: []
  # - BearerAuth: []

tags:
  - name: PayEvo
    description: Instruções gerais e informações sobre a plataforma PayEvo
  - name: Transação
    description: Endpoints para gerenciamento de transações de pagamento
  - name: Clientes
    description: Endpoints para gerenciamento de clientes
  - name: Financeiro
    description: Endpoints para consulta de saldo e antecipações
  - name: Conta
    description: Endpoints para informações da conta e empresa
  - name: Cashout
    description: Endpoints para gerenciamento de saques e transferências
  - name: Webhooks
    description: Endpoints para configuração e gerenciamento de webhooks

paths:
  /transactions:
    post:
      tags:
        - Transação
      summary: Criar transação
      description: |
        Para iniciar uma transação, utilize a rota /transactions. Esse endpoint suporta pagamentos via cartão de crédito, boleto e PIX.
      operationId: criarTransacao
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CriarTransacaoRequest'
            example:
              card:
                hash: "token_do_cartao_tokenizado"
              customer:
                name: "João Silva"
                email: "joao@email.com"
                document:
                  type: "CPF"
                  number: "12345678900"
              amount: 5000
              paymentMethod: "CARD"
              installments: 1
      responses:
        '200':
          description: Transação criada com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '400':
          description: Requisição inválida
        '401':
          description: Não autorizado
        '500':
          description: Erro interno do servidor

    get:
      tags:
        - Transação
      summary: Listar transações
      description: |
        Permite obter uma lista de todas as transações registradas, com possibilidade de filtragem por status e período.
      operationId: listarTransacoes
      parameters:
        - name: status
          in: query
          description: Filtrar por status da transação
          schema:
            type: string
            enum: [processing, authorized, paid, refunded, waiting_payment, refused, chargedback, canceled, in_protest, partially_paid]
        - name: startDate
          in: query
          description: Data inicial para filtro (formato ISO 8601)
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          description: Data final para filtro (formato ISO 8601)
          schema:
            type: string
            format: date-time
        - name: page
          in: query
          description: Número da página
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Limite de resultados por página
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Lista de transações
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /transactions/{id}:
    get:
      tags:
        - Transação
      summary: Buscar transação
      description: |
        Permite recuperar informações sobre uma transação específica informando seu ID.
      operationId: buscarTransacao
      parameters:
        - name: id
          in: path
          required: true
          description: ID da transação
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Dados da transação
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '404':
          description: Transação não encontrada

    post:
      tags:
        - Transação
      summary: Estornar transação
      description: |
        Permite solicitar o estorno de uma transação já processada.
      operationId: estornarTransacao
      parameters:
        - name: id
          in: path
          required: true
          description: ID da transação
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: integer
                  description: |
                    Valor a ser estornado em centavos (opcional, se não informado estorna o valor total)
      responses:
        '200':
          description: Estorno processado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '400':
          description: Requisição inválida
        '404':
          description: Transação não encontrada

    put:
      tags:
        - Transação
      summary: Alterar status de entrega
      description: |
        Permite alterar o status de entrega de uma transação específica.
      operationId: alterarStatusEntrega
      parameters:
        - name: id
          in: path
          required: true
          description: ID da transação
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - deliveryStatus
              properties:
                deliveryStatus:
                  type: string
                  description: Novo status de entrega
      responses:
        '200':
          description: Status de entrega atualizado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'

  /customers:
    post:
      tags:
        - Clientes
      summary: Criar cliente
      description: |
        O endpoint /customers permite cadastrar um novo cliente na plataforma.
      operationId: criarCliente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Customer'
      responses:
        '200':
          description: Cliente criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '400':
          description: Requisição inválida

    get:
      tags:
        - Clientes
      summary: Listar clientes
      description: |
        Permite obter uma lista de clientes cadastrados na plataforma, com suporte a filtros para facilitar a busca.
      operationId: listarClientes
      parameters:
        - name: page
          in: query
          description: Número da página
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Limite de resultados por página
          schema:
            type: integer
            default: 20
        - name: search
          in: query
          description: Buscar por nome, email ou documento
          schema:
            type: string
      responses:
        '200':
          description: Lista de clientes
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Customer'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /customers/{id}:
    get:
      tags:
        - Clientes
      summary: Buscar cliente
      description: |
        Permite recuperar as informações de um cliente específico cadastrado na plataforma.
      operationId: buscarCliente
      parameters:
        - name: id
          in: path
          required: true
          description: ID do cliente
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Dados do cliente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '404':
          description: Cliente não encontrado

    put:
      tags:
        - Clientes
      summary: Atualizar cliente
      description: |
        O endpoint /customers/{id} permite atualizar as informações de um cliente já cadastrado.
      operationId: atualizarCliente
      parameters:
        - name: id
          in: path
          required: true
          description: ID do cliente
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Customer'
      responses:
        '200':
          description: Cliente atualizado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '404':
          description: Cliente não encontrado

  /balance:
    get:
      tags:
        - Financeiro
      summary: Consultar saldo e reserva
      description: |
        Para consultar o saldo disponível, utilize a rota `/balance`.
      operationId: consultarSaldo
      responses:
        '200':
          description: Dados de saldo e reserva
          content:
            application/json:
              schema:
                type: object
                properties:
                  available:
                    type: integer
                    description: Saldo disponível em centavos
                  reserved:
                    type: integer
                    description: Valor reservado em centavos
                  total:
                    type: integer
                    description: Saldo total em centavos
        '400':
          description: Requisição inválida
  
  /company:
    get:
      tags:
        - Conta
      summary: Dados da empresa
      description: |
        O endpoint /company permite obter informações gerais sobre a empresa cadastrada na plataforma.
      operationId: dadosEmpresa
      responses:
        '200':
          description: Dados da empresa
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  document:
                    type: string
                  email:
                    type: string
                  phone:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
        '400':
          description: Requisição inválida

  /cashout:
    post:
      tags:
        - Cashout
      summary: Solicitar saque
      description: |
        Realizar um saque do saldo disponível para uma chave Pix.

        A **x-api-key** necessária para autenticação pode ser encontrada no Gateway, em Integrações → Chave de API.
      operationId: solicitarSaque
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SolicitarSaque'
            example:
              requestedamount: 2000
              pixkey: "11911111111"
              type: "PHONE"
              description: "Saque Cashout"
      responses:
        '200':
          description: Saque realizado com sucesso
        '400':
          description: Requisição inválida
        '401':
          description: Não autorizado
        '500':
          description: Erro interno do servidor

components:
  securitySchemes:
    basicAuth:
        type: http
        scheme: basic
        description: |
          Autenticação usando Basic Authentication. 
          Use sua SECRET_KEY como usuário e "x" como senha, ou encode no formato "SECRET_KEY:x" em base64.
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: Token de autenticação fornecido no Gateway, localizado em Integrações → Chave de API.

    # BearerAuth:
    #   type: http
    #   scheme: bearer
    #   bearerFormat: JWT
    #   description: |
    #     Autenticação usando Bearer Authentication.
    #     Para acessar os recursos da API, é necessário autenticar-se utilizando o método **Basic Authentication**, fornecendo sua chave secreta como credencial.

  schemas:
    Postback:
      type: object
      description: |
        Ao registrar uma transação, é possível definir uma URL específica para receber notificações 
        sempre que houver atualizações no status da transação. Para isso, utilize o campo `postbackUrl`. 
        Os dados enviados para essa URL seguirão o formato apresentado abaixo.
      properties:
        id:
          type: string
          description: ID do evento de postback
        type:
          type: string
          enum: [transaction]
          description: Tipo do evento
        objectId:
          type: string
          format: uuid
          description: ID do objeto relacionado (transação)
        data:
          $ref: '#/components/schemas/Transaction'

    Transaction:
      type: object
      description: |
        Ao criar uma transação, este é o objeto que você recebe como resposta. 
        Você também receberá esse objeto quando ocorrer uma atualização de status da transação no seu postbackUrl.
      properties:
        id:
          type: string
          format: uuid
          description: ID da transação
        status:
          type: string
          enum: [processing, authorized, paid, refunded, waiting_payment, refused, chargedback, canceled, in_protest, partially_paid]
          description: Status da transação
        amount:
          type: string
          description: |
            Valor da transação em centavos. Exemplo: R$ 5,00 = 500
        paidAmount:
          type: integer
          description: Valor pago em centavos
        refundedAmount:
          type: integer
          description: Valor estornado em centavos
        paymentMethod:
          type: string
          enum: [CARD, PIX, BOLETO]
          description: Meio de pagamento utilizado na transação
        installments:
          type: integer
          description: Quantidade de parcelas da transação
        customer:
          $ref: '#/components/schemas/Customer'
        shipping:
          $ref: '#/components/schemas/Shipping'
        card:
          $ref: '#/components/schemas/Card'
        pix:
          $ref: '#/components/schemas/Pix'
        boleto:
          $ref: '#/components/schemas/Boleto'
        companyId:
          type: string
          format: uuid
          description: ID da empresa que criou a transação
        postbackUrl:
          type: string
          format: uri
          description: URL de postback que receberá as atualizações de status da transação
          x-nullable: true
        metadata:
          type: object
          additionalProperties: true
          description: Objeto com dados adicionais informados na criação da transação
        createdAt:
          type: string
          format: date-time
          description: Data de criação da transação
        updatedAt:
          type: string
          format: date-time
          description: Data da última atualização da transação
        ip:
          type: string
          description: |
            IP de origem que criou a transação, podendo ser diretamente de seu cliente, 
            caso a requisição venha diretamente do client-side, ou de seus servidores, 
            caso tudo esteja centralizando em sua aplicação no server-side.
        refusedReason:
          $ref: '#/components/schemas/RefusedReason'
        items:
          type: array
          items:
            $ref: '#/components/schemas/Item'
          description: Dados sobre os produtos comprados
        splits:
          type: array
          items:
            $ref: '#/components/schemas/Split'
          description: Regras de divisão da transação
        paidAt:
          type: string
          format: date-time
          x-nullable: true
        fee:
          $ref: '#/components/schemas/Fee'
        description:
          type: string
          description: Descrição da transação

    CriarTransacaoRequest:
      type: object
      required:
        - customer
        - amount
        - paymentMethod
      properties:
        customer:
          $ref: '#/components/schemas/Customer'
        amount:
          type: integer
          description: Valor da transação em centavos
        paymentMethod:
          type: string
          enum: [CARD, PIX, BOLETO]
          description: Método de pagamento
        installments:
          type: integer
          description: Número de parcelas (apenas para cartão)
          default: 1
        card:
          type: object
          properties:
            hash:
              type: string
              description: Token do cartão tokenizado (obtido via Shark Banking SDK)
        description:
          type: string
          description: Descrição da transação
        postbackUrl:
          type: string
          format: uri
          description: URL para receber notificações de mudança de status
        metadata:
          type: object
          additionalProperties: true
          description: Dados adicionais em formato JSON
        shipping:
          $ref: '#/components/schemas/Shipping'
        items:
          type: array
          items:
            $ref: '#/components/schemas/Item'

    Customer:
      type: object
      required:
        - name
        - email
        - document
      properties:
        id:
          type: string
          format: uuid
          description: ID do cliente
        name:
          type: string
          description: Nome completo do cliente
        email:
          type: string
          format: email
          description: Email do cliente
        phone:
          type: string
          description: Telefone do cliente (somente números)
        document:
          type: object
          required:
            - type
            - number
          properties:
            type:
              type: string
              enum: [CPF, CNPJ]
              description: Tipo de documento
            number:
              type: string
              description: Número do documento (somente números)
        createdAt:
          type: string
          format: date-time
          description: Data de criação do cliente

    Shipping:
      type: object
      properties:
        street:
          type: string
          description: Nome da rua
        streetNumber:
          type: string
          description: Número do endereço
        complement:
          type: string
          description: Complemento do endereço
        neighborhood:
          type: string
          description: Bairro
        city:
          type: string
          description: Cidade
        state:
          type: string
          description: Estado (2 letras)
        zipCode:
          type: string
          description: CEP (somente números)
        country:
          type: string
          default: BR
          description: País

    Card:
      type: object
      properties:
        id:
          type: string
          format: uuid
        last4:
          type: string
          description: Últimos 4 dígitos do cartão
        brand:
          type: string
          description: Bandeira do cartão
        holderName:
          type: string
          description: Nome do portador do cartão

    Pix:
      type: object
      properties:
        qrcode:
          type: string
          format: uri
          description: URL do QR Code para pagamento
        expirationDate:
          type: string
          format: date-time
          description: Data de expiração do PIX
        end2EndId:
          type: string
          description: ID end-to-end da transação PIX
          x-nullable: true
        receiptUrl:
          type: string
          format: uri
          description: URL do comprovante de pagamento
          x-nullable: true

    Boleto:
      type: object
      properties:
        barcode:
          type: string
          description: Código de barras do boleto
        ourNumber:
          type: string
          description: Nosso número do boleto
        expirationDate:
          type: string
          format: date
          description: Data de vencimento do boleto
        pdfUrl:
          type: string
          format: uri
          description: URL do PDF do boleto

    RefusedReason:
      type: object
      description: |
        Quando uma transação no cartão de crédito for recusada, 
        esse campo estará preenchido com o motivo da recusa.
      properties:
        code:
          type: string
          description: Código do motivo da recusa
        message:
          type: string
          description: Mensagem descritiva do motivo da recusa

    Item:
      type: object
      properties:
        title:
          type: string
          description: Título do produto
        unitPrice:
          type: integer
          description: Preço unitário em centavos
        quantity:
          type: integer
          description: Quantidade
        externalRef:
          type: string
          description: Referência externa do produto

    Split:
      type: object
      description: Regra de divisão da transação
      properties:
        recipientId:
          type: string
          format: uuid
          description: ID do recebedor
        percentage:
          type: number
          format: float
          description: Percentual da divisão
        netAmount:
          type: integer
          description: Valor líquido em centavos
      example:
        recipientId: "909c81fe-0511-442c-b2a8-ca06b0fd8042"
        percentage: 100
        netAmount: 200

    Fee:
      type: object
      properties:
        fixedAmount:
          type: integer
          description: Taxa fixa em centavos
        spreadPercentage:
          type: number
          format: float
          description: Percentual de spread
        estimatedFee:
          type: integer
          description: Taxa estimada em centavos
        netAmount:
          type: integer
          description: Valor líquido em centavos

    Pagination:
      type: object
      properties:
        page:
          type: integer
          description: Página atual
        limit:
          type: integer
          description: Limite por página
        total:
          type: integer
          description: Total de registros
        totalPages:
          type: integer
          description: Total de páginas

    SolicitarSaque:
      type: object
      required:
        - requestedamount
        - pixkey
        - type
      properties:
        requestedamount:
          type: integer
          description: Valor da transação em centavos
        pixkey:
          type: string
          description: Chave Pix para onde o valor será transferido
        type:
          type: string
          enum: [CPF, CNPJ, PHONE, EMAIL, EVP]
        description:
          type: string
          description: Descrição da transação
